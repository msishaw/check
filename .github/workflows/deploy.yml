name: deploy

on:
  workflow_run:
    workflows: ["check"]
    branches: [main]
    types:
      - completed

jobs:
  on-success:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests to succeed
        if: ${{ github.event.workflow_run.conclusion != 'success'  }}
        run: exit 1
      - name: clone repo
        run: |
            REPO="https://${{ github.token }}@github.com/${{ github.repository }}.git"
            BRANCH="${GITHUB_REF/#refs\/heads\//}"
            git clone --filter=blob:none --no-checkout --depth 1 --sparse $REPO .
            git sparse-checkout init --cone --sparse-index
            git sparse-checkout set ${{ inputs.patterns }}
            git -c protocol.version=2 fetch --no-tags --prune --progress --depth=1 origin +${GITHUB_SHA}:refs/remotes/origin/${BRANCH}
            git checkout --progress --force -B $BRANCH refs/remotes/origin/$BRANCH
        shell: bash
      - name: heroku build
        uses: ./.github/heroku-build
        with:
          app-name: "${{secrets.APP}}"
          api-key: "${{secrets.KEY}}"
      - name: heroku-deploy
        uses: ./.github/heroku-deploy
        with:
          heroku_api_key: ${{ secrets.KEY }}
          heroku_app_name: ${{ secrets.APP }}
          heroku_email: ${{ secrets.MAIL }}
